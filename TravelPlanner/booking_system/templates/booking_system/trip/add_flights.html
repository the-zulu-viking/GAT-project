{% extends "base.html" %}
{% block title %}Add Flights{% endblock %}
{% block body %}

<h2 class="mb-4">Step 3: Add Flights</h2>
<div class="progress mb-4">
  <div class="progress-bar bg-warning" style="width: 100%">Flights</div>
</div>

<form method="POST">
  {% csrf_token %}
  {{ formset.management_form }}

  <div id="flight-formset">
    {% for form in formset %}
      <div class="card mb-3 p-3">
        <h6>Flight {{ forloop.counter }}</h6>
        <div class="row g-2">
          {% for field in form.visible_fields %}
            <div class="col-md-6">
              <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
              {{ field }}
              {% if field.errors %}
                <div class="text-danger small">{{ field.errors }}</div>
              {% endif %}
            </div>
          {% endfor %}
        </div>
        {% if form.can_delete %}
          <div class="mt-2">
            <label>{{ form.DELETE }} Remove this flight</label>
          </div>
        {% endif %}
      </div>
    {% endfor %}
  </div>

  <button type="submit" class="btn btn-primary">Save Flights</button>
  <button type="button" id="add-flight" class="btn btn-outline-secondary">Add Another Flight</button>
</form>

<script>
  document.getElementById('add-flight').addEventListener('click', function () {
    const totalForms = document.getElementById('id_form-TOTAL_FORMS');
    const currentFormCount = parseInt(totalForms.value);
    const formCopyTarget = document.getElementById('flight-formset');
    const emptyForm = document.getElementById('empty-form').innerHTML.replace(/__prefix__/g, currentFormCount);

    formCopyTarget.insertAdjacentHTML('beforeend', emptyForm);
    totalForms.value = currentFormCount + 1;
  });
</script>

<!-- Hidden empty form for JS cloning -->
<div id="empty-form" class="d-none">
  {{ formset.empty_form.as_p|safe }}
</div>

{% endblock %}
